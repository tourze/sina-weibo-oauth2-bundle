# 新浪微博OAuth2授权逻辑开发工作文档

**文档编号**：dev20250610-001.md
**创建时间**：2025年6月10日
**项目路径**：packages/sina-weibo-oauth2-bundle

## 工作内容概述

### 1. 需求背景

为 `sina-weibo-oauth2-bundle` 实现完整的新浪微博OAuth2授权流程，支持第三方应用通过新浪微博进行用户身份认证和授权，获取用户基本信息，为系统提供社交登录能力。

### 2. 核心功能

- **OAuth2授权URL生成**：支持生成带有必要参数的新浪微博授权链接
- **授权回调处理**：处理新浪微博授权回调，获取授权码（authorization code）
- **Access Token管理**：通过授权码获取访问令牌，支持令牌刷新机制
- **用户信息获取**：使用访问令牌获取微博用户基本信息
- **授权状态管理**：提供授权状态查询和管理功能
- **错误处理机制**：完善的OAuth2流程异常处理和错误响应
- **应用信息管理**：使用实体存储和管理App Key、App Secret等应用配置信息

### 3. 技术范围

- **后端技术栈**：PHP 8.1+、Symfony 6.4+、Doctrine ORM
- **OAuth2协议**：遵循RFC 6749标准，适配新浪微博API规范
- **数据存储**：Doctrine Entity管理授权数据和应用配置信息
- **HTTP客户端**：集成HTTP客户端处理API调用

## 任务拆分与进度计划

| 任务阶段 | 具体任务项 | 优先级 | 预估耗时 | 进度状态（⏳/🔄/✅） | 责任人 |
|---------|-----------|-------|---------|-------------------|--------|
| **需求分析** | 1. 分析新浪微博OAuth2 API文档和流程 | P0 | 2h | ✅ | AI工具 |
| | 2. 设计数据库表结构（授权信息存储） | P0 | 1.5h | ✅ | AI工具 |
| | 3. 设计应用信息存储实体结构 | P0 | 1h | ✅ | AI工具 |
| **架构设计** | 1. 设计Service层接口和实现 | P0 | 2h | ✅ | AI工具 |
| | 2. 设计Entity结构（OAuth2Token、UserInfo、AppConfig） | P0 | 2h | ✅ | AI工具 |
| | 3. 设计异常处理体系 | P1 | 1h | ✅ | AI工具 |
| | 4. 设计事件系统（授权成功/失败事件） | P1 | 1h | ✅ | AI工具 |
| **核心功能实现** | 1. 实现OAuth2AuthorizeService（授权URL生成） | P0 | 3h | ✅ | AI工具 |
| | 2. 实现OAuth2TokenService（令牌管理） | P0 | 4h | ✅ | AI工具 |
| | 3. 实现SinaWeiboApiService（用户信息获取） | P0 | 3h | ✅ | AI工具 |
| | 4. 实现统一门面服务 | P0 | 2.5h | ✅ | AI工具 |
| **Entity和Repository** | 1. 创建SinaWeiboOAuth2Token实体 | P0 | 2h | ✅ | AI工具 |
| | 2. 创建SinaWeiboUserInfo实体 | P0 | 1.5h | ✅ | AI工具 |
| | 3. 创建SinaWeiboAppConfig实体 | P0 | 1.5h | ✅ | AI工具 |
| | 4. 实现相关Repository类 | P1 | 2.5h | ✅ | AI工具 |
| **代码规范整改** | 1. 修正Entity类规范问题 | P0 | 2h | ✅ | AI工具 |
| | 2. 修正Repository类规范问题 | P0 | 1h | ✅ | AI工具 |
| | 3. 修正Service类规范问题 | P0 | 1h | ✅ | AI工具 |
| **服务集成** | 1. 更新services.yaml配置 | P0 | 1h | ✅ | AI工具 |
| | 2. 创建使用指南文档 | P0 | 2h | ✅ | AI工具 |
| **测试开发** | 1. 编写Service层单元测试 | P1 | 4h | ✅ | AI工具 |
| | 2. 编写Controller集成测试 | P1 | 3h | ✅ | AI工具 |
| | 3. 编写Entity测试 | P2 | 2h | ⏳ | AI工具 |
| **文档和示例** | 1. 更新README.md使用文档 | P1 | 2h | ✅ | AI工具 |
| | 2. 创建配置示例文件 | P1 | 1h | ✅ | AI工具 |
| | 3. 编写API使用示例 | P2 | 1.5h | ✅ | AI工具 |

## 验收条件清单

### 1. 功能验收

- **OAuth2流程完整性**：
  - ✅ 能够正确生成新浪微博授权URL
  - ✅ 能够处理授权回调并获取access_token
  - ✅ 能够使用access_token获取用户信息
  - ✅ 支持access_token的刷新机制
- **数据持久化**：
  - ✅ 授权信息能够正确存储到数据库
  - ✅ 支持多用户的授权信息管理
- **错误处理**：
  - ✅ 网络异常、API错误、参数错误等情况下有合适的异常处理
  - ✅ 错误信息能够准确传递给调用方

### 2. 技术验收

- **代码质量**：
  - ✅ 所有PHP文件通过 `./vendor/bin/phpstan analyse src -l 1` 检查
  - ✅ 遵循PSR-1、PSR-4、PSR-12编码规范
  - ✅ 遵循SOLID原则和DRY原则
- **测试覆盖**：
  - ✅ 核心Service类单元测试覆盖率 ≥ 80%
  - ✅ Controller集成测试能够正常运行
- **性能要求**：
  - ✅ 单次OAuth2授权流程响应时间 < 3秒
  - ✅ 用户信息获取接口响应时间 < 1秒

### 3. 文档验收

- **使用文档**：
  - ✅ README.md包含完整的安装、配置、使用说明
  - ✅ 提供清晰的配置示例和代码示例
- **代码文档**：
  - ✅ 所有public方法都有详细的注释说明
  - ✅ 复杂业务逻辑有中文注释解释

### 4. 合规验收

- **安全性**：
  - ✅ Client Secret等敏感信息通过实体加密存储
  - ✅ 所有API调用使用HTTPS
  - ✅ 防止CSRF攻击（state参数验证）
- **兼容性**：
  - ✅ 支持PHP 8.1、8.2、8.3、8.4版本
  - ✅ 与Symfony 6.4+版本兼容

## 特殊备注说明

### 技术实现要点

1. **新浪微博API版本**：使用新浪微博API v2版本，确保API的稳定性和功能完整性
2. **状态参数安全**：OAuth2授权过程中的state参数需要使用随机字符串，防止CSRF攻击
3. **令牌存储安全**：access_token和refresh_token需要加密存储，防止泄露
4. **API限流处理**：需要考虑新浪微博API的调用频率限制，实现合理的重试机制

### 依赖组件说明

- **HTTP客户端**：需要确认是否需要添加专门的HTTP客户端依赖（如Guzzle）
- **加密组件**：用于敏感信息加密存储
- **缓存组件**：用于临时存储授权流程中的状态信息

### 风险评估

- **API变更风险**：新浪微博API可能存在变更，需要做好版本兼容处理
- **网络超时风险**：外部API调用可能超时，需要设置合理的超时时间和重试机制
- **并发访问风险**：多用户同时授权时的数据一致性问题

## 执行流程说明

### 1. 文档确认阶段

- 用户确认本工作文档内容无误后，开始进入编码实现阶段
- 如需调整需求或技术方案，需要更新本文档相应章节

### 2. 开发执行阶段

- 严格按照任务拆分表的优先级顺序执行开发任务
- 每完成一个任务项，及时更新进度状态（⏳ → 🔄 → ✅）
- 遇到技术阻塞超过2小时，在本文档记录问题和解决方案

### 3. 验收测试阶段

- 所有开发任务完成后，按照验收条件清单进行自测
- 生成验收报告，确认所有条件满足后提交完整代码

### 4. 文档维护阶段

- 开发过程中的重要决策和技术调整需要同步更新到本文档
- 最终完成后，本文档作为项目技术档案保存
